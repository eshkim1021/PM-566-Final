---
title: "PM 566 Midterm Assignment"
author: "Edward Kim"
date: "10/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(tidyverse)
library(httr)
library(dplyr)
```


## Introduction
  
  The COVID-19 pandemic still heavily impacts the United States, with the US surpassing over 200,000 deaths since cases have first been recorded. To shed further insight into the severity of the panemic, the __"Provisional COVID-19 Death Count by Sex, Age, and State"__ (https://data.cdc.gov/resource/9bhg-hcku.json) data was taken from the __Center for Disease Control__ and analyzed. The data includes the number of COCIVD-19 deaths between February 2020 and August 2020 that was reported to the __National Center for Health Statistics__ by sex, age group, and state. In addition, the number of deaths due to pneumonia, often caused by severe COVID symptoms, was also included in the data set. Data gathered by this data set is incomplete due to the length of time in which it takes for a death certificate to be completed and submitted to the NCHS after death. In addition, not all states are represented in this data. 
  
  
The main purpose of this project is to analyze:

1)The effect of __age__, __gender__, and __geographical location__ on the COVID-19 mortality rate.

2)The frequency of __pneumonia__ in COVID-19 patients, and its affect on patient mortality. 
  
## Methods 

The dataset, __"Provisional COVID-19 Death Count by Sex, Age, and State"__ (https://data.cdc.gov/resource/9bhg-hcku.json), was accessed from the __Center for Disease Control__ website through an API. Once downloaded, the desired information was extracted through regular expressions and formed into a data table. The key independent variables that were examined in this study were __age__, __gender__, __state__, while the data of interest included number of __deaths from COVID-19__, number of __deaths from pneumonia__, and the number of deaths which both __COVID-19 and pneumonia__ were involved. 

```{r Obtain API, include = FALSE}
data <- GET(
  url = "https://data.cdc.gov",
  path = "/resource/9bhg-hcku.json"
  
)
data <- content(data)
dat <- as.character(data)
```


```{r Web Scrapping,include = FALSE}
#

#Extract Gender
gender <- str_extract_all(dat, "sex = \"[:alpha:]+ [:alpha:]+|sex = \"[:alpha:]+")
gender <- str_remove_all(gender, "sex = \"")

#Extract state of death 
state <- str_extract_all(dat, "state = \"[:alpha:]+|state = \"[:alpha:]+ [:alpha:]+")
state <- str_remove_all(state, "state = \"")

#Extract age group 
age_group <- str_extract_all(dat, "age_group_new = \"[0-9]+-[0-9]+ [:alpha:]+|age_group_new = \"[:alpha:]+ [:alpha:]+|age_group_new = \"[:alpha:]+ [0-9]+ [:alpha:]+|age_group_new = \"[0-9]+ [:alpha:]+ [:alpha:]+ [:alpha:]+")
age_group <-str_remove_all(age_group, "age_group_new = \"")

#Covid-19 Deaths 
covid <- str_extract_all(dat," covid_19_deaths = \"[:alnum:]+")
covid <- str_remove_all(covid, " covid_19_deaths = \"")

#Pneumonia_deaths
pneumonia <- str_extract_all(dat, "pneumonia_deaths = \"[:alnum:]+")
pneumonia <- str_remove_all(pneumonia, "pneumonia_deaths = \"")

#Pneumonia and COVID Deaths 
both <- str_extract_all(dat, "pneumonia_and_covid_19_deaths = \"[:alnum:]+")
both <- str_remove_all(both,"pneumonia_and_covid_19_deaths = \"")

#Total_Deaths 
total <- str_extract_all(dat,"total_deaths = \"[:alnum:]+")
total <- str_remove_all(total, "total_deaths = \"")
```

```{r Create overall databse, message = FALSE,include = FALSE}
#Create and clean up COVID-19 death data frame 
database <- data.frame(
  Gender = gender,
  State = state,
  Age_Group = age_group,
  Covid_Deaths = covid,
  Pneumonia_Deaths = pneumonia,
  Covid_and_Pneumonia_Deaths = both,
  Total_Deaths = total
)

database %>% count(Gender)

knitr::kable(database)
```

### Looking at Age, State, Gender:

```{r,include = FALSE}
#Group by independent variables. 
q1 <- data.frame(
  Gender = gender,
  State = state,
  Age_Group = age_group,
  Covid_Deaths = covid
)
q1 <- q1 %>% mutate(Covid_Deaths = as.numeric(Covid_Deaths))

q1 %>% count(Age_Group)

```

#### Age:

The age variable was separated into different age groups, including ranges from 0-17, 15-24, 18-29, etc. When the age group was extracted from the raw data, there were observations that did not include data regarding the age. Therefore, those observations were removed. 

In addition, there were also overlapping age-ranges in the data set. To prevent double-counting of deaths, the overlapping age-ranges were removed. The final age groups started from age 5 to age 84, broken down into increments of 10 years, as shown below: 

```{r Create Table for Age and COVID-19 Death,message = FALSE,include = FALSE}
Age<- q1 %>%
 filter(!(Covid_Deaths %in% NA)) %>% 
  filter(!(Age_Group %in% "All Ages"))%>%
  filter(!(Age_Group %in% "Under 1 year"))%>%
  filter(!(Age_Group %in% "1-4 years"))%>%
  filter(!(Age_Group %in% "0-17 years"))%>%
  filter(!(Age_Group %in% "18-29 years"))%>%
  filter(!(Age_Group %in% "30-49 years"))%>%
  filter(!(Age_Group %in% "50-64 years"))%>%
  filter(!(Age_Group %in% "85 years and over"))%>%
  group_by(Age_Group) %>% 
  group_by(Age_Group) %>% 
  summarise_at(vars(Covid_Deaths), list(Covid_Deaths=sum))

Age <- Age[c(5,1,2,3,4,6,7,8),]
```

```{r Table for Age and COVID-19 Death,echo= FALSE}
knitr::kable(Age)  
```

#### State: 

Covid-19 data from only 20 states were reported in this data set. In addition, some observations listed the location of death as the "United States." Because the goal of this project is to determine the influence of location (state) on COVID-19 mortality, these values were removed from the final data set. Missing values were also removed. 

```{r Create Table for State and COVID-19 Death,include = FALSE}
state_death <- q1 %>% 
  filter(!(Covid_Deaths %in% NA)) %>% 
  filter(!(State %in% "United"))%>% 
  group_by(State)%>%
  summarise_at(vars(Covid_Deaths),list("Covid Death"= sum))
```

```{r Table for States, echo = FALSE}
knitr::kable(state_death)
```

#### Gender:

The number of deaths due to COVID-19 was separated by gender. Some observation listed the gender as "All Genders." Because the goal of this project is to determine the influence of gender on COVID-19 mortality, these values were removed. In addition, removing those values would prevent double-counting of the data. Cases where the gender was unknown were also removed. 

```{r Create Table for Gender and COVID-19 Death,include = FALSE}
gender_death <- q1 %>% 
  filter(!(Covid_Deaths %in% NA)) %>%
  filter(!(Gender %in% "All Sexes")) %>% 
  filter(!(Gender %in% "Unknown")) %>% 
  group_by(Gender)%>%
  summarise_at(vars(Covid_Deaths), list("Covid Death" = sum))

```

```{r Table for Gender and COVID-19 Death, echo = FALSE}
knitr::kable(gender_death)
```

### Looking at COVID-19 Deaths and Pneumonia Deaths by Age 
```{r,include = FALSE, warning = FALSE}
database <- database %>% mutate(Covid_Deaths = as.numeric(Covid_Deaths))
database <- database %>% mutate(Pneumonia_Deaths = as.numeric(Pneumonia_Deaths))
database <- database %>% mutate(Covid_and_Pneumonia_Deaths = as.numeric(Covid_and_Pneumonia_Deaths))
database <- database %>% mutate(Total_Deaths=as.numeric(Total_Deaths))

q2a<- database %>%
  filter(!(Covid_Deaths %in% NA)) %>% 
  filter(!(Age_Group %in% "All Ages"))%>%
  filter(!(Age_Group %in% "Under 1 year"))%>%
  filter(!(Age_Group %in% "1-4 years"))%>%
  filter(!(Age_Group %in% "0-17 years"))%>%
  filter(!(Age_Group %in% "18-29 years"))%>%
  filter(!(Age_Group %in% "30-49 years"))%>%
  filter(!(Age_Group %in% "50-64 years"))%>%
  filter(!(Age_Group %in% "85 years and over"))%>%
  group_by(Age_Group) %>% 
  summarise_at(vars(Covid_Deaths), list(Covid_Deaths=sum))

q2b <- database %>% 
  filter(!(Pneumonia_Deaths %in% NA)) %>% 
  filter(!(Age_Group %in% "All Ages"))%>%
  filter(!(Age_Group %in% "0-17 years"))%>%
  group_by(Age_Group) %>% 
  summarise_at(vars(Pneumonia_Deaths), list(Pneumonia_Deaths=sum))

q2c <- database %>% 
  filter(!(Covid_and_Pneumonia_Deaths %in% NA)) %>% 
  filter(!(Age_Group %in% "All Ages"))%>%
  filter(!(Age_Group %in% "0-17 years"))%>%
  group_by(Age_Group) %>% 
  summarise_at(vars(Covid_and_Pneumonia_Deaths), list(Covid_and_Pneumonia_Deaths=sum))

q2 <-merge(q2a,q2b, by = "Age_Group")
q2 <- merge(q2,q2c, by = "Age_Group")
  
q2 <- q2[c(5,1:4,6:8),]
```

```{r Table for Q2, echo = FALSE}
knitr::kable(q2)
```


## Preliminary Results 

## Conclusion 
